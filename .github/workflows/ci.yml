name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: read
  packages: write
  checks: write

jobs:
  ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        image:
          - file: images/python-3.14-trixie-slim.dockerfile
            name: python
            tag: 3.14-trixie-slim
          - file: images/python-3.14-trixie-slim-gdal.dockerfile
            name: python
            tag: 3.14-trixie-slim-gdal
          - file: images/python-3.13-trixie-slim.dockerfile
            name: python
            tag: 3.13-trixie-slim
          - file: images/python-3.13-trixie-slim-gdal.dockerfile
            name: python
            tag: 3.13-trixie-slim-gdal
          - file: images/python-3.12-trixie-slim.dockerfile
            name: python
            tag: 3.12-trixie-slim
          - file: images/python-3.12-trixie-slim-gdal.dockerfile
            name: python
            tag: 3.12-trixie-slim-gdal
          - file: images/python-3.11-trixie-slim.dockerfile
            name: python
            tag: 3.11-trixie-slim
          - file: images/python-3.11-trixie-slim-gdal.dockerfile
            name: python
            tag: 3.11-trixie-slim-gdal
          - file: images/python-3.10-trixie-slim.dockerfile
            name: python
            tag: 3.10-trixie-slim
          - file: images/python-3.10-trixie-slim-gdal.dockerfile
            name: python
            tag: 3.10-trixie-slim-gdal
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Docker Setup QEMU
        if: ${{ github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3.7.0

      - name: Build
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          file: ${{ matrix.image.file }}
          platforms: linux/amd64
          load: true
          tags: ${{ matrix.image.name }}:${{ matrix.image.tag }}

      - name: Run Trivy vulnerability scanner
        id: trivy
        continue-on-error: true
        uses: aquasecurity/trivy-action@e368e328979b113139d6f9068e03accaed98a518 # v0.34.1
        with:
          image-ref: ${{ matrix.image.name }}:${{ matrix.image.tag }}
          format: table
          exit-code: 1
          ignore-unfixed: true
          severity: CRITICAL,HIGH

      - name: Report vulnerabilities as neutral check
        if: steps.trivy.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Vulnerabilities found (${{ matrix.image.name }}:${{ matrix.image.tag }})',
              head_sha: context.payload.pull_request?.head?.sha ?? context.sha,
              status: 'completed',
              conclusion: 'neutral',
              output: {
                title: 'Vulnerabilities found',
                summary: 'Image `${{ matrix.image.name }}:${{ matrix.image.tag }}` has unfixed CRITICAL/HIGH vulnerabilities.',
              }
            });

      - name: Log in to GitHub Container Registry
        if: ${{ steps.trivy.outcome == 'success' && (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) }}
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        if: ${{ steps.trivy.outcome == 'success' && (github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')) }}
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          file: ${{ matrix.image.file }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/${{ github.actor }}/${{ matrix.image.name }}:${{ matrix.image.tag }}
          labels: org.opencontainers.image.source=https://github.com/${{ github.repository }}
